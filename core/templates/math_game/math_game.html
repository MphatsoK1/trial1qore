{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Poppins', 'Roboto', sans-serif;
        }
        .answer-box {
            width: 140px;
            text-align: center;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: 3px solid #1d4ed8;
            border-radius: 16px;
            padding: 16px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }
        .answer-box:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3);
            transform: scale(1.05);
        }
        .answer-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .feedback-correct {
            color: #10b981;
            font-weight: bold;
            animation: bounce 0.5s ease;
        }
        .feedback-wrong {
            color: #ef4444;
            font-weight: bold;
            animation: shake 0.5s ease;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti-fall 2s linear forwards;
        }
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        .problem-display {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .difficulty-easy { background: #d1fae5; color: #065f46; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        .difficulty-expert { background: #e0e7ff; color: #3730a3; }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }
        
        .streak-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-2xl mx-auto p-4 sm:p-6 min-h-screen flex flex-col">
        <!-- Header -->
        <div class="flex items-center mb-4 sm:mb-6">
            <a href="{% url 'games_page' %}" class="text-gray-600 hover:text-gray-800 mr-3 sm:mr-4">
                <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="text-xl sm:text-2xl font-semibold text-gray-800">Math Game</h1>
            <div class="ml-auto text-sm text-gray-600">
                Level <span id="current-level">1</span>
            </div>
        </div>

        <!-- Game Info Card -->
        <div class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 mb-4">
            <!-- Title Row -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center text-purple-500">
                    <span class="text-2xl sm:text-3xl mr-2">üßÆ</span>
                    <span class="font-semibold text-base sm:text-lg">Math Game</span>
                </div>
                <div class="text-sm sm:text-base text-gray-600 font-medium">
                    <span id="problems-completed">0</span>/<span id="problems-required">10</span>
                </div>
            </div>

            <!-- AI Buddy Header -->
            <div class="bg-gradient-to-r from-purple-400 to-pink-500 rounded-xl p-4 flex items-center justify-between text-white shadow-md">
                <div class="flex items-center flex-1">
                    <span class="text-3xl sm:text-4xl mr-3">ü¶â</span>
                    <div>
                        <div class="font-bold text-base sm:text-lg">AI Buddy Math!</div>
                        <div class="text-xs sm:text-sm opacity-90">Solve math problems</div>
                    </div>
                </div>
                <div class="text-right ml-4">
                    <div class="text-xs sm:text-sm opacity-90">Score:</div>
                    <div class="font-bold text-2xl sm:text-3xl" id="score">0</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Level Progress</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="level-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Timer & Difficulty -->
        <div class="bg-white rounded-2xl shadow-sm p-4 mb-4 flex items-center justify-between">
            <div class="flex items-center text-orange-500">
                <i class='bx bx-time text-xl mr-2'></i>
                <span class="font-semibold" id="timer">03:00</span>
            </div>
            <div class="difficulty-badge" id="difficulty-badge">Easy</div>
        </div>

        <!-- Game Area -->
        <div class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 mb-4 flex-1 flex flex-col items-center justify-center">
            <p class="text-center text-gray-600 text-sm font-medium mb-6">
                Solve the math problem below
            </p>
            
            <div class="problem-display mb-8 text-center" id="problem">
                3 + 5 = ?
            </div>
            
            <input 
                type="number" 
                class="answer-box" 
                id="answer" 
                placeholder="?" 
                autocomplete="off"
                min="0"
                max="100"
            >
            
            <div id="streak-display" class="mt-4"></div>
            <p class="text-base mt-4 text-center min-h-6" id="feedback"></p>
        </div>

        <!-- Buddy's Tip -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 mb-4 flex items-start shadow-sm border border-purple-100">
            <span class="text-3xl sm:text-4xl mr-3 flex-shrink-0">ü¶â</span>
            <div>
                <div class="font-bold text-gray-800 mb-1 text-sm sm:text-base">Buddy's Tip:</div>
                <div class="text-xs sm:text-sm text-gray-600" id="tip">Take your time and double-check your calculations!</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex gap-3">
            <button onclick="useHint()" class="flex-1 bg-gradient-to-r from-orange-400 to-orange-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition">
                <i class='bx bx-bulb'></i> Hint
            </button>
            <button onclick="skipProblem()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition">
                <i class='bx bx-skip-next'></i> Skip
            </button>
            <button onclick="checkAnswer()" class="flex-1 bg-gradient-to-r from-green-400 to-green-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition">
                <i class='bx bx-check-circle'></i> Check
            </button>
        </div>
    </div>

    <!-- Level Complete Modal -->
    <div id="level-complete-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2" id="modal-title">Level Complete!</h2>
            <p class="text-gray-600 mb-4" id="modal-message">Great job solving math problems!</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-500" id="modal-score">0</div>
                    <div class="text-sm text-gray-600">Score</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-500" id="modal-problems">0</div>
                    <div class="text-sm text-gray-600">Problems</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-orange-500" id="modal-streak">0</div>
                    <div class="text-sm text-gray-600">Max Streak</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-500" id="modal-accuracy">0%</div>
                    <div class="text-sm text-gray-600">Accuracy</div>
                </div>
            </div>
            
            <button onclick="nextLevel()" class="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition">
                Continue to Next Level
            </button>
        </div>
    </div>

    <!-- Game Complete Modal -->
    <div id="game-complete-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Game Complete!</h2>
            <p class="text-gray-600 mb-4">Amazing! You've completed all math levels!</p>
            
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg p-4 mb-6 text-white">
                <div class="text-3xl font-bold" id="final-score">0</div>
                <div class="text-sm">Final Score</div>
            </div>
            
            <button onclick="restartGame()" class="w-full bg-gradient-to-r from-green-400 to-green-500 text-white py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition mb-3">
                Play Again
            </button>
            <button onclick="exitGame()" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition">
                Exit Game
            </button>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="correct-sound" src="{% static 'sounds/yay.mp3' %}"></audio>
    <audio id="wrong-sound" src="{% static 'sounds/sounds.mp3' %}"></audio>
    <audio id="level-complete-sound" src="{% static 'sounds/yay.mp3' %}"></audio>

    <script>
        // Game state
        let currentLevel = 1;
        let currentProblemIndex = 0;
        let problems = [];
        let score = 0;
        let problemsCompleted = 0;
        let currentStreak = 0;
        let maxStreak = 0;
        let totalAttempts = 0;
        let correctAttempts = 0;
        let timer = 180;
        let gameActive = false;
        let sessionId = null;
        let soundEnabled = true;

        // DOM elements
        const elements = {
            score: document.getElementById('score'),
            timer: document.getElementById('timer'),
            problem: document.getElementById('problem'),
            answer: document.getElementById('answer'),
            feedback: document.getElementById('feedback'),
            currentLevel: document.getElementById('current-level'),
            problemsCompleted: document.getElementById('problems-completed'),
            problemsRequired: document.getElementById('problems-required'),
            levelProgress: document.getElementById('level-progress'),
            progressText: document.getElementById('progress-text'),
            difficultyBadge: document.getElementById('difficulty-badge'),
            tip: document.getElementById('tip'),
            streakDisplay: document.getElementById('streak-display')
        };

        // Audio elements
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        const levelCompleteSound = document.getElementById('level-complete-sound');

        // Generate session ID
        function generateSessionId() {
            return 'math_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize game
        async function initGame() {
            sessionId = generateSessionId();
            
            // Start game session
            await fetch('/api/math-game/start-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    player_name: '{{ request.user.username|default:"Player" }}'
                })
            });
            
            loadLevel(1);
        }

        // Load level
        async function loadLevel(level) {
            try {
                const response = await fetch(`/api/math-game/level/?level=${level}`);
                const data = await response.json();
                
                if (data.error) {
                    showGameComplete();
                    return;
                }
                
                currentLevel = data.level_number;
                problems = data.problems;
                currentProblemIndex = 0;
                problemsCompleted = 0;
                currentStreak = 0;
                timer = data.time_limit;
                
                // Update UI
                elements.currentLevel.textContent = currentLevel;
                elements.problemsRequired.textContent = data.problems_required;
                elements.difficultyBadge.textContent = data.difficulty.charAt(0).toUpperCase() + data.difficulty.slice(1);
                elements.difficultyBadge.className = `difficulty-badge difficulty-${data.difficulty}`;
                
                updateProgress();
                generateProblem();
                startTimer();
                gameActive = true;
                
            } catch (error) {
                console.error('Error loading level:', error);
            }
        }

        // Generate current problem
        function generateProblem() {
            if (currentProblemIndex >= problems.length) {
                levelComplete();
                return;
            }
            
            const problem = problems[currentProblemIndex];
            elements.problem.textContent = problem.display_text;
            elements.answer.value = '';
            elements.feedback.textContent = '';
            elements.answer.focus();
            
            // Update tip based on operation
            updateTip(problem.operation);
        }

        // Check answer
        function checkAnswer() {
            if (!gameActive) return;
            
            const userAnswer = parseInt(elements.answer.value);
            totalAttempts++;
            
            if (isNaN(userAnswer)) {
                showFeedback('Please enter a number!', 'wrong');
                return;
            }

            const correctAnswer = problems[currentProblemIndex].correct_answer;
            
            if (userAnswer === correctAnswer) {
                // Correct answer
                correctAttempts++;
                problemsCompleted++;
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);
                
                // Calculate score with streak bonus
                let points = 10;
                if (currentStreak >= 3) points += 5;
                if (currentStreak >= 5) points += 5;
                if (currentStreak >= 10) points += 10;
                
                score += points;
                
                showFeedback(`‚úì Correct! +${points} points!`, 'correct');
                playSound(correctSound);
                createConfetti();
                
                setTimeout(() => {
                    currentProblemIndex++;
                    updateProgress();
                    generateProblem();
                }, 1500);
                
            } else {
                // Wrong answer
                currentStreak = 0;
                showFeedback(`‚úó Wrong! The answer is ${correctAnswer}`, 'wrong');
                playSound(wrongSound);
            }
            
            updateStreakDisplay();
            updateProgress();
        }

        // Use hint
        function useHint() {
            if (!gameActive) return;
            
            const problem = problems[currentProblemIndex];
            let hint = '';
            
            switch(problem.operation) {
                case '+':
                    hint = `Try adding ${problem.problem_text.split('+')[0]} and ${problem.problem_text.split('+')[1]}`;
                    break;
                case '-':
                    hint = `Try subtracting ${problem.problem_text.split('-')[1]} from ${problem.problem_text.split('-')[0]}`;
                    break;
                case '√ó':
                    hint = `Try multiplying ${problem.problem_text.split('√ó')[0]} by ${problem.problem_text.split('√ó')[1]}`;
                    break;
                case '√∑':
                    hint = `Try dividing ${problem.problem_text.split('√∑')[0]} by ${problem.problem_text.split('√∑')[1]}`;
                    break;
            }
            
            elements.feedback.innerHTML = `<span class="text-blue-500">üí° ${hint}</span>`;
            speak(hint);
        }

        // Skip problem
        function skipProblem() {
            if (!gameActive) return;
            
            currentStreak = 0;
            showFeedback('Skipped to next problem', 'info');
            speak('Skipped. Here is a new problem.');
            
            currentProblemIndex++;
            updateProgress();
            generateProblem();
            updateStreakDisplay();
        }

        // Show feedback
        function showFeedback(message, type) {
            elements.feedback.textContent = message;
            elements.feedback.className = type === 'correct' ? 'feedback-correct' : 
                                       type === 'wrong' ? 'feedback-wrong' : 
                                       'text-blue-500';
        }

        // Update progress
        function updateProgress() {
            elements.score.textContent = score;
            elements.problemsCompleted.textContent = problemsCompleted;
            
            const progress = (problemsCompleted / parseInt(elements.problemsRequired.textContent)) * 100;
            elements.levelProgress.style.width = `${progress}%`;
            elements.progressText.textContent = `${Math.round(progress)}%`;
        }

        // Update streak display
        function updateStreakDisplay() {
            if (currentStreak > 1) {
                elements.streakDisplay.innerHTML = `<div class="streak-badge">
                    <i class='bx bx-trending-up'></i> ${currentStreak} Streak!
                </div>`;
            } else {
                elements.streakDisplay.innerHTML = '';
            }
        }

        // Update tip
        function updateTip(operation) {
            const tips = {
                '+': "Remember: Addition combines numbers to make a larger number!",
                '-': "Tip: Subtraction takes away from the first number!",
                '√ó': "Hint: Multiplication is repeated addition!",
                '√∑': "Remember: Division splits into equal parts!"
            };
            elements.tip.textContent = tips[operation] || "Take your time and double-check your work!";
        }

        // Timer
        function startTimer() {
            const timerInterval = setInterval(() => {
                if (timer > 0 && gameActive) {
                    timer--;
                    const minutes = Math.floor(timer / 60);
                    const seconds = timer % 60;
                    elements.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else if (timer <= 0 && gameActive) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        function timeUp() {
            gameActive = false;
            showFeedback('‚è∞ Time\'s up! Level completed.', 'wrong');
            setTimeout(levelComplete, 2000);
        }

        // Level complete
        function levelComplete() {
            gameActive = false;
            playSound(levelCompleteSound);
            
            // Update progress in backend
            updateGameProgress();
            
            const accuracy = totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0;
            
            document.getElementById('modal-score').textContent = score;
            document.getElementById('modal-problems').textContent = problemsCompleted;
            document.getElementById('modal-streak').textContent = maxStreak;
            document.getElementById('modal-accuracy').textContent = accuracy + '%';
            
            document.getElementById('level-complete-modal').classList.add('active');
        }

        // Next level
        async function nextLevel() {
            document.getElementById('level-complete-modal').classList.remove('active');
            
            // Check if next level exists
            const response = await fetch(`/api/math-game/next-level/?current_level=${currentLevel}`);
            const data = await response.json();
            
            if (data.error) {
                showGameComplete();
            } else {
                loadLevel(currentLevel + 1);
            }
        }

        // Show game complete
        function showGameComplete() {
            document.getElementById('final-score').textContent = score;
            document.getElementById('game-complete-modal').classList.add('active');
        }

        // Restart game
        function restartGame() {
            document.getElementById('game-complete-modal').classList.remove('active');
            score = 0;
            currentStreak = 0;
            maxStreak = 0;
            totalAttempts = 0;
            correctAttempts = 0;
            initGame();
        }

        // Exit game
        function exitGame() {
            window.location.href = "{% url 'games_page' %}";
        }

        // Update game progress in backend
        async function updateGameProgress() {
            await fetch('/api/math-game/update-progress/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    level: currentLevel,
                    score: score,
                    problems_completed: problemsCompleted,
                    perfect_streak: maxStreak,
                    total_attempts: totalAttempts,
                    correct_attempts: correctAttempts,
                    time_spent: 180 - timer
                })
            });
        }

        // Utility functions
        function playSound(audioElement) {
            if (soundEnabled) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function speak(text) {
            if (soundEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8;
                utterance.pitch = 1.2;
                speechSynthesis.speak(utterance);
            }
        }

        function createConfetti() {
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                confetti.style.backgroundColor = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Enter key support
        elements.answer.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });

        // Sound toggle
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const button = document.getElementById('sound-btn');
            button.innerHTML = soundEnabled ? 
                "<i class='bx bx-volume-full'></i> Sound" : 
                "<i class='bx bx-volume-mute'></i> Muted";
            speak(soundEnabled ? 'Sound enabled' : 'Sound muted');
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>