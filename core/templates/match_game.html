<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fun Exercise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', 'Roboto', sans-serif; background-color: #f9f9f9; overflow-x: hidden; }
    .animal-icon { width: 60px; height: 60px; background-color: #87CEEB; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 10px 0; }
    .label { width: 100px; height: 40px; background-color: #fff3e6; border: 1px solid #ddd; border-radius: 5px; display: flex; align-items: center; justify-content: center; margin: 5px 0; cursor: move; user-select: none; }
    .dropzone { width: 100px; height: 40px; border: 2px dashed #ccc; border-radius: 5px; margin: 5px 0; display: flex; align-items: center; justify-content: center; }
    .dropzone.correct { border-color: #4CAF50; background-color: #e8f5e9; }
    .dropzone.incorrect { border-color: #f44336; background-color: #ffebee; }
  </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4">
  <div class="w-full max-w-md">
    <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-lg shadow">
      <h1 class="text-lg font-bold text-purple-600">Fun Exercise</h1>
      <span class="text-sm text-gray-600" id="timer">03:00</span>
    </div>
    <div class="bg-blue-100 p-2 rounded-lg mb-4 flex justify-between items-center">
      <span class="text-sm text-blue-800">Match & Learn</span>
      <span class="text-sm text-gray-600" id="score">0/4</span>
    </div>
    <div class="bg-white p-4 rounded-lg shadow mb-4">
      <p class="text-purple-600 text-sm mb-4">Match each animal to its name!</p>
      <div class="flex flex-col space-y-4">
        <div class="flex space-x-4">
          <div class="animal-icon"></div>
          <div class="dropzone" data-answer="Dog"></div>
        </div>
        <div class="flex space-x-4">
          <div class="animal-icon"></div>
          <div class="dropzone" data-answer="Cat"></div>
        </div>
        <div class="flex space-x-4">
          <div class="animal-icon"></div>
          <div class="dropzone" data-answer="Bird"></div>
        </div>
        <div class="flex space-x-4">
          <div class="animal-icon"></div>
          <div class="dropzone" data-answer="Fish"></div>
        </div>
      </div>
    </div>
    <button class="w-full bg-teal-500 text-white py-2 rounded-lg text-sm mb-4" id="submit-btn">Submit Answer</button>
    <div class="flex justify-between w-full">
      <button class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">Hint</button>
      <button class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm" id="next-btn">Next</button>
    </div>
  </div>
  <div class="mt-4">
    <div class="label" draggable="true">Dog</div>
    <div class="label" draggable="true">Cat</div>
    <div class="label" draggable="true">Bird</div>
    <div class="label" draggable="true">Fish</div>
  </div>
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function sendScore(finalScore) {
      const csrftoken = getCookie('csrftoken');
      let milestone = '';
      if (finalScore === 4) {
        milestone = 'Matching Master';
      } else if (finalScore >= 2) {
        milestone = 'Good Matcher';
      }
      fetch("{% url 'save_score' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          game_name: 'Fun Exercise',
          score: finalScore,
          milestone: milestone
        })
      }).then(response => {
        if (response.ok) {
          console.log('Score saved successfully');
        } else {
          console.error('Failed to save score');
        }
      }).catch(error => console.error('Error:', error));
    }

    const labels = document.querySelectorAll('.label');
    const dropzones = document.querySelectorAll('.dropzone');
    const submitButton = document.querySelector('#submit-btn');
    const timerDisplay = document.querySelector('#timer');
    const scoreDisplay = document.querySelector('#score');
    let timer = 180; // 3 minutes in seconds
    let gameActive = true;

    labels.forEach(label => {
      label.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', label.textContent);
      });
    });

    dropzones.forEach(dropzone => {
      dropzone.addEventListener('dragover', (e) => e.preventDefault());
      dropzone.addEventListener('drop', (e) => {
        if (!gameActive) return;
        e.preventDefault();
        const data = e.dataTransfer.getData('text/plain');
        if (!dropzone.children.length) {
          const label = document.createElement('div');
          label.textContent = data;
          label.className = 'label dropped';
          dropzone.appendChild(label);
        }
      });
    });

    const timerInterval = setInterval(() => {
      if (timer > 0 && gameActive) {
        timer--;
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      } else if (timer <= 0) {
        gameActive = false;
        clearInterval(timerInterval);
        let correct = 0;
        dropzones.forEach(dropzone => {
          const droppedLabel = dropzone.querySelector('.dropped');
          if (droppedLabel && droppedLabel.textContent === dropzone.dataset.answer) {
            correct++;
          }
        });
        alert(`Game Over! You matched ${correct}/4 correctly.`);
        sendScore(correct); // Send score to database
      }
    }, 1000);

    submitButton.addEventListener('click', () => {
      if (!gameActive) return;
      let correct = 0;
      dropzones.forEach(dropzone => {
        const droppedLabel = dropzone.querySelector('.dropped');
        if (droppedLabel && droppedLabel.textContent === dropzone.dataset.answer) {
          dropzone.classList.add('correct');
          dropzone.classList.remove('incorrect');
          correct++;
        } else if (droppedLabel) {
          dropzone.classList.add('incorrect');
          dropzone.classList.remove('correct');
        } else {
          dropzone.classList.remove('correct', 'incorrect');
        }
      });
      scoreDisplay.textContent = `${correct}/4`;
      gameActive = false;
      clearInterval(timerInterval);
      alert(`Game Finished! You matched ${correct}/4 correctly.`);
      sendScore(correct); // Send score to database
    });

    document.querySelector('#next-btn').addEventListener('click', () => {
      if (!gameActive) return;
      // Reset game logic can be added here if needed
    });
  </script>
  {% include 'bottom_nav.html' %}
</body>
</html>